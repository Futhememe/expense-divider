import {
  Button,
  Divider,
  Flex,
  Heading,
  Highlight,
  IconButton,
  ListItem,
  Text,
  Tooltip,
  UnorderedList,
  useDisclosure,
} from "@chakra-ui/react";
import type { NextPage } from "next";
import Head from "next/head";
import { Container } from "../components/Container";
import { Main } from "../components/Main";
import { Percentage } from "../components/Percentage";
import { ExpenseModal } from "../components/ExpenseModal";
import { useLocalStorage } from "../hooks/useLocalStorage";
import { ExpenseDTO, useExpenseStore } from "../store";
import { useEffect, useState } from "react";
import { DeleteIcon, EditIcon } from "@chakra-ui/icons";
import { DeleteModal } from "../components/DeleteModal";

const Home: NextPage = () => {
  const { isOpen, onOpen, onClose } = useDisclosure();
  const {
    isOpen: isDeleteOpen,
    onOpen: onDeleteOpen,
    onClose: onDeleteClose,
  } = useDisclosure();
  const [storageList] = useLocalStorage<ExpenseDTO[]>("expenseList", []);
  const { setAllExpenses, expenseList } = useExpenseStore();
  const [selectedExpense, setSelectedExpense] = useState<string | null>(null);

  const formatToBRL = (amount: number) =>
    new Intl.NumberFormat("pt-BR", {
      style: "currency",
      currency: "BRL",
    }).format(amount);

  useEffect(() => {
    setAllExpenses(storageList);
  }, [storageList]);

  return (
    <Container>
      <Head>
        <title>Expense divider</title>
        <meta
          name="description"
          content="Generated by Futhememe boilerplate generator"
        />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <DeleteModal
        isOpen={isDeleteOpen}
        onClose={onDeleteClose}
        expenseId={selectedExpense ?? ""}
      />
      <ExpenseModal isOpen={isOpen} onClose={onClose} />
      <Main>
        <Heading textAlign="center">Lançamentos</Heading>
        <Percentage />
        <Tooltip
          placement="bottom"
          label="Clique aqui para adicionar um novo lançamento"
        >
          <Button w="100%" colorScheme="green" onClick={onOpen}>
            + lançamento
          </Button>
        </Tooltip>
        <Divider />
        {expenseList.map((expense) => (
          <Flex key={expense.id} w="100%" flexDir="column">
            <Flex justifyContent="space-between">
              <Heading fontSize="2xl" mb="1rem">
                {expense.expenseName} = &nbsp;
                <Highlight
                  query={formatToBRL(expense.total)}
                  styles={{ color: "#C39A47" }}
                >
                  {formatToBRL(expense.total)}
                </Highlight>
              </Heading>
              <Flex>
                <IconButton
                  colorScheme="transparent"
                  aria-label="edit expense"
                  icon={<EditIcon />}
                />
                <IconButton
                  colorScheme="transparent"
                  aria-label="delete expense"
                  onClick={() => {
                    onDeleteOpen();
                    setSelectedExpense(expense.id);
                  }}
                  icon={<DeleteIcon />}
                />
              </Flex>
            </Flex>
            <UnorderedList fontWeight="medium" mb="1.5rem">
              <ListItem mb="0.5rem">
                <Highlight
                  query={formatToBRL(expense.esther)}
                  styles={{ color: "#59936D" }}
                >
                  {`Esther -> ${formatToBRL(expense.esther)}`}
                </Highlight>
              </ListItem>
              <ListItem>
                <Highlight
                  query={formatToBRL(expense.gustavo)}
                  styles={{ color: "#59936D" }}
                >
                  {`Gustavo -> ${formatToBRL(expense.gustavo)}`}
                </Highlight>
              </ListItem>
            </UnorderedList>
            <Divider />
          </Flex>
        ))}
      </Main>
    </Container>
  );
};

export default Home;
